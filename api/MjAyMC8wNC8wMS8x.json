{"title":"如何优雅的实现软件切换图标","date":"2020-04-01T14:59:26.000Z","date_formatted":{"ll":"Apr 1, 2020","L":"04/01/2020","MM-DD":"04-01"},"link":"2020/04/01/1","tags":["安卓"],"updated":"2020-04-05T04:06:39.020Z","content":"<h3 id=\"前言\">前言<a href=\"#前言\" title=\"前言\"></a></h3><h2 id=\"提到切换app图标，用个activity-alias就能解决。在此基础上，一个软件有多个图标时，那么如何优雅的来切换呢？\">提到切换app图标，用个activity-alias就能解决。在此基础上，一个软件有多个图标时，那么如何优雅的来切换呢？<a href=\"#提到切换app图标，用个activity-alias就能解决。在此基础上，一个软件有多个图标时，那么如何优雅的来切换呢？\" title=\"提到切换app图标，用个activity-alias就能解决。在此基础上，一个软件有多个图标时，那么如何优雅的来切换呢？\"></a></h2><p><em>如果不知道什么是activity-alias，可以看下这篇 <a href=\"https://blog.csdn.net/hansion3333/article/details/54946304\" target=\"_blank\">文章</a></em></p>\n<h3 id=\"思路\">思路<a href=\"#思路\" title=\"思路\"></a></h3><p>获取自身app所有的activity<br>然后判断activity是否同时拥有Intent.ACTION_MAIN和Intent.CATEGORY_LAUNCHER，有就显示到列表中</p>\n<h3 id=\"准备\">准备<a href=\"#准备\" title=\"准备\"></a></h3><p>先配置一下xml，这里多设置几个图标</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">activity</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:name</span>=<span class=\"string\">\".MainActivity\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:label</span>=<span class=\"string\">\"@string/app_name\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.action.MAIN\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.category.LAUNCHER\"</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">activity-alias</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:name</span>=<span class=\"string\">\".MainActivity1\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:enabled</span>=<span class=\"string\">\"false\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:icon</span>=<span class=\"string\">\"@drawable/a\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:label</span>=<span class=\"string\">\"名字1\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:targetActivity</span>=<span class=\"string\">\".MainActivity\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.action.MAIN\"</span> /&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.category.LAUNCHER\"</span> /&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">activity-alias</span>&gt;</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">activity-alias</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:name</span>=<span class=\"string\">\".MainActivity2\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:enabled</span>=<span class=\"string\">\"false\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:icon</span>=<span class=\"string\">\"@drawable/b\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:label</span>=<span class=\"string\">\"名字2\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:targetActivity</span>=<span class=\"string\">\".MainActivity\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.action.MAIN\"</span> /&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.category.LAUNCHER\"</span> /&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">activity-alias</span>&gt;</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">activity-alias</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:name</span>=<span class=\"string\">\".MainActivity3\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:enabled</span>=<span class=\"string\">\"false\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:icon</span>=<span class=\"string\">\"@drawable/c\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:label</span>=<span class=\"string\">\"名字3\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:targetActivity</span>=<span class=\"string\">\".MainActivity\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.action.MAIN\"</span> /&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.category.LAUNCHER\"</span> /&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">activity-alias</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id=\"获取所有的activity\">获取所有的activity<a href=\"#获取所有的activity\" title=\"获取所有的activity\"></a></h3><p>最开始的方案是使用</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PackageInfo info = getPackageManager().getPackageInfo(getPackageName(), <span class=\"number\">1</span>);</span><br><span class=\"line\">                    ActivityInfo[] activitts = info.activities;</span><br><span class=\"line\">                    <span class=\"keyword\">for</span>(ActivityInfo act : activitts) &#123;</span><br><span class=\"line\">                       Log.d(TAG,act.toString()); </span><br><span class=\"line\">                    &#125;</span><br></pre></td></tr></table></figure><p>但获取到的结果却是</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">04-05 01:51:23.077 29341 29341 D   ketal                                        ActivityInfo&#123;fd6138b com.ketal.changeicon.MainActivity&#125;</span><br></pre></td></tr></table></figure><p>为什么只有MainActivity？<br>那是因为activity-alias添加了android:enabled=”false”<br>通过PackageManager的API获取到的activity经过了过滤，所以这么获取就不行。</p>\n<hr>\n<p>那有没有其他的方法？<br>自己去解析AndroidManifest.xml显然太麻烦<br>apk在安装的时候，系统会解析AndroidManifest.xml，通过查阅安装apk相关的系统源码我找到了==android.content.pm.PackageParser==。</p>\n<p>由于这个类注解了@hide<br>写个反射调用。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">getActivitys</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Class cls = Class.forName(<span class=\"string\">\"android.content.pm.PackageParser\"</span>);</span><br><span class=\"line\">            Object parse = cls.newInstance();</span><br><span class=\"line\">            String apkPath = getPackageManager().getPackageInfo(getPackageName(), PackageManager.GET_ACTIVITIES).applicationInfo.sourceDir;</span><br><span class=\"line\">            File apk = <span class=\"keyword\">new</span> File(apkPath);</span><br><span class=\"line\">            Method m1 = cls.getMethod(<span class=\"string\">\"parsePackage\"</span>,<span class=\"keyword\">new</span> Class[]&#123;File<span class=\"class\">.<span class=\"keyword\">class</span>,<span class=\"title\">int</span>.<span class=\"title\">class</span>&#125;)</span>;</span><br><span class=\"line\">            Object pack =m1.invoke(parse,<span class=\"keyword\">new</span> Object[]&#123;apk,PackageManager.GET_ACTIVITIES&#125;);</span><br><span class=\"line\">            Class cls2 = pack.getClass();</span><br><span class=\"line\">            Field field = cls2.getDeclaredField(<span class=\"string\">\"activities\"</span>);</span><br><span class=\"line\">            field.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">            List list = (List)field.get(pack);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> list;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure><p>得到的结果也很完美</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure><h3 id=\"a\">a<a href=\"#a\" title=\"a\"></a></h3>","next":{"title":"Hello World","link":"2020/04/01/hello-world"},"plink":"http://yoursite.com/2020/04/01/1/","toc":[{"id":"前言","title":"前言","index":"1"}]}